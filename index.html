<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Калькулятор КБЖУ</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#1a1a1a;color:#e8e8e8;padding:24px 20px}
.container{max-width:680px;margin:0 auto}
h1{font-size:32px;margin-bottom:32px;font-weight:400}

.ingredient{background:#2d2d2d;padding:24px;border-radius:16px;margin-bottom:16px}
.ingredient-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.ingredient-number{color:#9b9b9b;font-size:15px}
.remove-btn{background:none;border:none;color:#a35705;font-size:18px;cursor:pointer;width:24px;height:24px}

.autocomplete-wrapper{position:relative}
.autocomplete-list{
  position:absolute;top:calc(100% + 6px);left:0;right:0;
  background:#2d2d2d;border:1px solid #404040;border-radius:12px;
  max-height:240px;overflow-y:auto;display:none;z-index:10
}
.autocomplete-list.show{display:block}

.autocomplete-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 14px;cursor:pointer
}
.autocomplete-item:hover{background:#3a3a3a}
.autocomplete-item .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.auto-del{background:none;border:none;color:#a35705;font-size:16px;cursor:pointer}

.autocomplete-list::-webkit-scrollbar{width:8px}
.autocomplete-list::-webkit-scrollbar-thumb{background:#3a3a3a;border-radius:8px}

label{display:block;margin-bottom:8px;font-size:14px;color:#9b9b9b}
input{
  width:100%;padding:14px;border-radius:10px;
  border:1px solid #404040;background:#1a1a1a;color:#e8e8e8;
  margin-bottom:16px;font-size:16px
}

.kbju-labels,.kbju-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kbju-labels label{margin:0;font-size:13px}
.kbju-grid input{text-align:left}

button{
  width:100%;padding:16px;border-radius:12px;
  border:1px solid #404040;background:#2d2d2d;
  color:#e8e8e8;font-size:16px;cursor:pointer
}
button:disabled{opacity:.5;cursor:not-allowed}
.calculate-btn{background:#a35705;color:#fff;margin-top:24px}
</style>
</head>

<body>
<div class="container">
<h1>Калькулятор КБЖУ</h1>

<div id="ingredients"></div>
<button id="addIngredientBtn">Добавить ингредиент</button>

<label>Вес готового блюда (г)</label>
<input id="finalWeight" placeholder="Автоматически">

<button class="calculate-btn" id="calculateBtn" disabled>Рассчитать</button>
</div>

<script>
const productDatabase = [
 {name:'Масло подсолнечное',cal:899,prot:0,fat:99.9,carb:0},
 {name:'Масло сливочное',cal:748,prot:0.5,fat:82.5,carb:0.8},
 {name:'Грудка куриная',cal:113,prot:23.6,fat:1.9,carb:0.4},
 {name:'Картофель сырой',cal:77,prot:2,fat:0.4,carb:16.3},
 {name:'Лук репчатый сырой',cal:41,prot:1.4,fat:0.2,carb:8.2}
];

let customProducts = JSON.parse(localStorage.getItem('custom_products')||'[]')
  .filter(p=>p&&p.name&&p.name.trim());

let ingredientId=0;
const active=[];

function normalize(s){
 return s.toLowerCase().replace(/\s+/g,' ').trim();
}

function parseNum(v){
 if(!v)return NaN;
 return parseFloat(String(v).replace(',','.'));
}

function addIngredient(){
 ingredientId++;
 active.push(ingredientId);

 const wrap=document.createElement('div');
 wrap.className='ingredient';
 wrap.id='ing-'+ingredientId;

 const first=active.length===1;
 wrap.innerHTML=`
  <div class="ingredient-header">
    <span class="ingredient-number">Ингредиент ${active.length}</span>
    ${first?'':'<button class="remove-btn">✕</button>'}
  </div>

  <div class="autocomplete-wrapper">
    <label>Название</label>
    <input id="name-${ingredientId}">
    <div class="autocomplete-list" id="list-${ingredientId}"></div>
  </div>

  <div class="kbju-labels">
    <label>Калории</label><label>Белки</label><label>Жиры</label><label>Углев.</label>
  </div>
  <div class="kbju-grid">
    <input id="cal-${ingredientId}">
    <input id="prot-${ingredientId}">
    <input id="fat-${ingredientId}">
    <input id="carb-${ingredientId}">
  </div>

  <label>Вес (г)</label>
  <input id="w-${ingredientId}">
 `;
 document.getElementById('ingredients').appendChild(wrap);

 const nameInput=wrap.querySelector(`#name-${ingredientId}`);
 const list=wrap.querySelector(`#list-${ingredientId}`);

 nameInput.addEventListener('input',()=>{
  const q=normalize(nameInput.value);
  list.innerHTML='';
  if(!q){list.classList.remove('show');return;}

  const locals=customProducts
    .filter(p=>normalize(p.name).startsWith(q))
    .sort((a,b)=>a.name.localeCompare(b.name));

  const base=productDatabase
    .filter(p=>normalize(p.name).startsWith(q))
    .sort((a,b)=>a.name.localeCompare(b.name));

  if(!locals.length&&!base.length){
    list.classList.remove('show');return;
  }

  [...locals.map(p=>({...p,_local:true})),...base].forEach(p=>{
    const row=document.createElement('div');
    row.className='autocomplete-item';
    row.innerHTML=`
      <span class="name">${p.name}</span>
      ${p._local?'<button class="auto-del">✕</button>':'<span style="width:18px"></span>'}
    `;
    row.onclick=()=>{
      nameInput.value=p.name;
      ['cal','prot','fat','carb'].forEach(k=>{
        wrap.querySelector(`#${k}-${ingredientId}`).value=p[k];
      });
      list.classList.remove('show');
      check();
    };
    if(p._local){
      row.querySelector('.auto-del').onclick=e=>{
        e.stopPropagation();
        customProducts=customProducts.filter(x=>normalize(x.name)!==normalize(p.name));
        localStorage.setItem('custom_products',JSON.stringify(customProducts));
        nameInput.dispatchEvent(new Event('input'));
      };
    }
    list.appendChild(row);
  });
  list.classList.add('show');
 });

 wrap.querySelectorAll('input').forEach(i=>i.addEventListener('input',check));
 if(!first)wrap.querySelector('.remove-btn').onclick=()=>{
  wrap.remove();
  active.splice(active.indexOf(ingredientId),1);
  check();
 };
}

function check(){
 let ok=true,total=0;
 active.forEach(id=>{
  const n=document.getElementById(`name-${id}`)?.value.trim();
  const w=parseNum(document.getElementById(`w-${id}`)?.value);
  ['cal','prot','fat','carb'].forEach(k=>{
    if(!isFinite(parseNum(document.getElementById(`${k}-${id}`)?.value)))ok=false;
  });
  if(!n||!isFinite(w))ok=false;
  total+=isFinite(w)?w:0;
 });
 document.getElementById('finalWeight').value=total||'';
 document.getElementById('calculateBtn').disabled=!ok;
}

document.getElementById('addIngredientBtn').onclick=addIngredient;
addIngredient();
</script>
</body>
</html>
