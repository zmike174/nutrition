<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Калькулятор КБЖУ</title>
<style>
/* --- Базовые стили --- */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
  background:#111;
  color:#e6e6e6;
  padding:24px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.45;
}
.container{max-width:760px;margin:0 auto}

/* Заголовок */
h1{font-size:28px;margin-bottom:20px;color:#f5f5f5;font-weight:400}

/* Ингредиент */
.ingredient{
  background:#1f1f1f;
  border:1px solid #323232;
  border-radius:12px;
  padding:18px;
  margin-bottom:14px;
}
.ingredient-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
  color:#bdbdbd;
  font-size:14px;
}
.remove-ingredient{
  background:none;
  border:none;
  color:#ff7b45;
  font-size:18px;
  cursor:pointer;
  padding:6px;
  border-radius:6px;
}
.remove-ingredient:hover{background:rgba(255,123,69,0.08)}

/* Автодополнение */
.autocomplete-wrapper{position:relative;margin-bottom:10px}
.autocomplete-list{
  position:absolute;
  top:calc(100% + 8px);
  left:0;
  right:0;
  background:#1f1f1f;
  border:1px solid #323232;
  border-radius:10px;
  max-height:260px;
  overflow:auto;
  z-index:200;
  display:none;
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
}
.autocomplete-list.show{display:block}
.autocomplete-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  cursor:pointer;
  color:#e6e6e6;
  font-size:15px;
}
.autocomplete-item:hover{background:#2a2a2a}
.autocomplete-item .item-left{display:flex;align-items:center;gap:12px}
.autocomplete-item button.auto-del{
  background:none;border:none;color:#ff7b45;font-size:16px;cursor:pointer;padding:6px;border-radius:6px;
}
.autocomplete-item button.auto-del:hover{background:rgba(255,123,69,0.08)}

/* Метки и грид КБЖУ */
.kbju-labels{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:8px}
.kbju-labels label{font-size:13px;color:#9b9b9b;text-align:left;padding-left:6px}
.kbju-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}
.kbju-grid input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #323232;
  background:#0f0f0f;
  color:#fff;
  font-size:15px;
  -moz-appearance:textfield;
  -webkit-appearance:none;
  text-align:right; /* числа по правому краю */
}

/* Общие поля */
label{display:block;margin-bottom:8px;font-size:14px;color:#9b9b9b}
input[type="text"], input[type="number"], textarea{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #323232;
  background:#0f0f0f;color:#fff;font-size:15px;margin-bottom:12px;
}
textarea{min-height:84px;resize:vertical}

/* Кнопки */
.btn{
  width:100%;
  padding:14px;border-radius:12px;border:1px solid #343434;background:#2a2a2a;color:#fff;font-size:15px;cursor:pointer;
}
.btn:hover{background:#333}
.btn-primary{background:#a35705;border:none;font-weight:600;box-shadow:0 2px 12px rgba(163,87,5,0.18)}
.btn-disabled{background:#333;color:#777;cursor:not-allowed;border:1px solid #2a2a2a}

/* Результат — используем те же стили, только readonly инпуты */
.result{
  display:none;
  background:#1f1f1f;border:1px solid #323232;border-radius:12px;padding:18px;margin-top:18px;
}
.result.show{display:block}
.result h2{font-size:18px;color:#f5f5f5;margin-bottom:12px;font-weight:400}
.kbju-grid.readonly input[readonly]{
  background:#141414;
  border:1px solid #2f2f2f;
  color:#e89a3a;
  font-weight:700;
  cursor:default;
}

/* История */
.history{margin-top:24px}
.history-item{
  background:#1f1f1f;border:1px solid #323232;border-radius:10px;padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
}
.history-delete{background:none;border:none;color:#ff7b45;font-size:16px;cursor:pointer;padding:6px;border-radius:6px}
.history-delete:hover{background:rgba(255,123,69,0.08)}

/* Мелкие правки */
.helper-row{display:flex;gap:12px;align-items:center}
.small-muted{font-size:13px;color:#9b9b9b}
</style>
</head>
<body>
<div class="container">
  <h1>Калькулятор КБЖУ</h1>

  <div id="ingredients"></div>

  <button class="btn" id="addIngredientBtn">Добавить ингредиент</button>

  <div style="margin-top:18px;">
    <label>Вес готового блюда (г)</label>
    <input type="number" id="finalWeight" placeholder="Автоматически суммируется">
  </div>

  <div style="margin-top:6px;">
    <button class="btn btn-primary" id="calculateBtn">Рассчитать</button>
  </div>

  <div class="result" id="result">
    <h2>Результат (на 100 г)</h2>

    <div class="kbju-labels">
      <label>Калории</label>
      <label>Белки</label>
      <label>Жиры</label>
      <label>Углев.</label>
    </div>

    <div class="kbju-grid readonly">
      <input readonly id="resCalories" placeholder="0">
      <input readonly id="resProtein" placeholder="0">
      <input readonly id="resFat" placeholder="0">
      <input readonly id="resCarbs" placeholder="0">
    </div>

    <div style="margin-top:8px;">
      <label>Название блюда</label>
      <input type="text" id="dishName" placeholder="Например: Грудка в сухарях">

      <label>Заметка (необязательно)</label>
      <textarea id="dishNote" placeholder="Время готовки, особенности..."></textarea>

      <button class="btn btn-primary" id="saveBtn">Сохранить в историю</button>
      <button class="btn" id="newBtn" style="margin-top:10px">Рассчитать новое блюдо</button>
    </div>
  </div>

  <div class="history" id="historySection" style="display:none">
    <h2 class="small-muted">История блюд</h2>
    <div id="historyList"></div>
    <button class="btn" id="clearHistoryBtn" style="margin-top:8px">Очистить историю</button>
  </div>
</div>

<script>
/* ====== Данные (база + локальные) ====== */
const productDatabase = [
  { name: 'Масло подсолнечное', cal: 899, prot: 0, fat: 99.9, carb: 0 },
  { name: 'Масло сливочное', cal: 748, prot: 0.5, fat: 82.5, carb: 0.8 },
  { name: 'Грудка куриная', cal: 113, prot: 23.6, fat: 1.9, carb: 0.4 },
  { name: 'Яйцо куриное', cal: 157, prot: 12.7, fat: 11.5, carb: 0.7 },
  { name: 'Сухари панировочные', cal: 347, prot: 11.3, fat: 1.8, carb: 72.1 },
  { name: 'Морковь сырая', cal: 35, prot: 1.3, fat: 0.1, carb: 6.9 },
  { name: 'Картофель сырой', cal: 77, prot: 2, fat: 0.4, carb: 16.3 },
  { name: 'Лук репчатый сырой', cal: 41, prot: 1.4, fat: 0.2, carb: 8.2 }
];

let customProducts = JSON.parse(localStorage.getItem('custom_products') || '[]');
let history = JSON.parse(localStorage.getItem('kbju_history') || '[]');

let ingredientCount = 0;      // счётчик уникальных ингредиентов
const activeIngredients = []; // массив id текущих ингредиентов

/* ====== Утилиты ====== */
function getAllProducts() {
  // Локальные (custom) сначала по алфавиту, затем база
  const localSorted = (customProducts || []).slice().sort((a, b) => a.name.localeCompare(b.name));
  const baseSorted = (productDatabase || []).slice().sort((a, b) => a.name.localeCompare(b.name));
  return [...localSorted, ...baseSorted];
}

function saveCustomToStorage() {
  localStorage.setItem('custom_products', JSON.stringify(customProducts));
}

function saveHistoryToStorage() {
  localStorage.setItem('kbju_history', JSON.stringify(history));
}

/* ====== Создание / удаление ингредиента ====== */
function addIngredient(preFill = {}) {
  ingredientCount++;
  const id = ingredientCount;
  activeIngredients.push(id);

  const container = document.getElementById('ingredients');
  const div = document.createElement('div');
  div.className = 'ingredient';
  div.id = `ingredient-${id}`;

  div.innerHTML = `
    <div class="ingredient-header">
      <div class="helper-row"><span class="small-muted">Ингредиент</span></div>
      <button class="remove-ingredient" title="Удалить ингредиент" data-id="${id}">✕</button>
    </div>

    <div class="autocomplete-wrapper">
      <label>Название</label>
      <input type="text" id="name-${id}" placeholder="Начните вводить..." autocomplete="off">
      <div class="autocomplete-list" id="autocomplete-${id}"></div>
    </div>

    <div class="kbju-labels">
      <label>Калории</label>
      <label>Белки</label>
      <label>Жиры</label>
      <label>Углев.</label>
    </div>
    <div class="kbju-grid">
      <input type="number" step="0.1" id="cal-${id}" placeholder="0">
      <input type="number" step="0.1" id="prot-${id}" placeholder="0">
      <input type="number" step="0.1" id="fat-${id}" placeholder="0">
      <input type="number" step="0.1" id="carb-${id}" placeholder="0">
    </div>

    <label>Вес (г)</label>
    <input type="number" id="weight-${id}" placeholder="Например: 500">
  `;

  container.appendChild(div);

  // Привязки событий
  div.querySelector('.remove-ingredient').addEventListener('click', () => {
    removeIngredient(id);
  });

  const nameInput = document.getElementById(`name-${id}`);
  nameInput.addEventListener('input', () => showAutocomplete(id));
  nameInput.addEventListener('focus', () => showAutocomplete(id));
  // При клике вне автодопа — закрываем все списки
  document.addEventListener('click', (e) => {
    if (!e.target.closest(`#ingredient-${id} .autocomplete-wrapper`)) {
      const list = document.getElementById(`autocomplete-${id}`);
      if (list) list.classList.remove('show');
    }
  });

  // Автообновление итогового веса и состояния кнопки
  ['cal','prot','fat','carb','weight'].forEach(suffix => {
    const el = document.getElementById(`${suffix}-${id}`);
    if (el) {
      el.addEventListener('input', () => {
        updateTotalWeight();
        checkCalculateButton();
      });
    }
  });

  // если передали preFill, заполняем
  if (preFill.name) document.getElementById(`name-${id}`).value = preFill.name || '';
  if (preFill.cal !== undefined) document.getElementById(`cal-${id}`).value = preFill.cal;
  if (preFill.prot !== undefined) document.getElementById(`prot-${id}`).value = preFill.prot;
  if (preFill.fat !== undefined) document.getElementById(`fat-${id}`).value = preFill.fat;
  if (preFill.carb !== undefined) document.getElementById(`carb-${id}`).value = preFill.carb;
  if (preFill.weight !== undefined) document.getElementById(`weight-${id}`).value = preFill.weight;

  checkCalculateButton();
}

/* Удаление ингредиента */
function removeIngredient(id) {
  const el = document.getElementById(`ingredient-${id}`);
  if (!el) return;
  el.remove();
  const idx = activeIngredients.indexOf(id);
  if (idx > -1) activeIngredients.splice(idx, 1);
  updateIngredientNumbers();
  updateTotalWeight();
  checkCalculateButton();
}

function updateIngredientNumbers() {
  activeIngredients.forEach((id, i) => {
    const el = document.getElementById(`ingredient-${id}`);
    if (!el) return;
    const header = el.querySelector('.ingredient-header .helper-row .small-muted');
    if (header) header.textContent = `Ингредиент ${i+1}`;
  });
}

/* ====== Автодополнение с локальными продуктами сверху + удаление локального ====== */
function showAutocomplete(id) {
  const input = document.getElementById(`name-${id}`);
  const list = document.getElementById(`autocomplete-${id}`);
  const q = (input.value || '').trim().toLowerCase();

  if (!q) {
    list.classList.remove('show');
    return;
  }

  const all = getAllProducts();
  const matches = all.filter(p => p.name.toLowerCase().includes(q));
  if (!matches.length) {
    list.classList.remove('show');
    return;
  }

  // строим список: локальные сначала (getAllProducts уже отдаёт локальные первыми)
  list.innerHTML = '';
  matches.forEach(p => {
    const isLocal = customProducts.some(c => c.name === p.name);
    const item = document.createElement('div');
    item.className = 'autocomplete-item';
    const left = document.createElement('div');
    left.className = 'item-left';
    const nameSpan = document.createElement('span');
    nameSpan.textContent = p.name;
    nameSpan.style.flex = '1';
    left.appendChild(nameSpan);
    item.appendChild(left);

    // Если локальный — добавляем кнопку удаления
    if (isLocal) {
      const delBtn = document.createElement('button');
      delBtn.className = 'auto-del';
      delBtn.title = 'Удалить из локальной базы';
      delBtn.innerHTML = '✕';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm(`Удалить "${p.name}" из локальной базы?`)) {
          deleteLocalProduct(p.name);
          showAutocomplete(id); // обновить список
        }
      });
      item.appendChild(delBtn);
      // Клик по имени — выбрать продукт
      item.addEventListener('click', () => selectProduct(id, p.name, p.cal, p.prot, p.fat, p.carb));
    } else {
      // базовый — просто выбрать
      item.addEventListener('click', () => selectProduct(id, p.name, p.cal, p.prot, p.fat, p.carb));
    }

    list.appendChild(item);
  });

  list.classList.add('show');
}

/* Удаление локального продукта */
function deleteLocalProduct(name) {
  customProducts = (customProducts || []).filter(p => p.name !== name);
  saveCustomToStorage();
}

/* Выбор продукта из списка */
function selectProduct(id, name, cal, prot, fat, carb) {
  const nameEl = document.getElementById(`name-${id}`);
  if (nameEl) nameEl.value = name;
  const ids = ['cal','prot','fat','carb'];
  const vals = [cal, prot, fat, carb];
  ids.forEach((key,i) => {
    const el = document.getElementById(`${key}-${id}`);
    if (el) el.value = vals[i];
  });
  // закрываем автодоп
  const list = document.getElementById(`autocomplete-${id}`);
  if (list) list.classList.remove('show');
  checkCalculateButton();
}

/* ====== Итоговые вычисления ====== */
function updateTotalWeight() {
  let total = 0;
  activeIngredients.forEach(id => {
    const w = parseFloat(document.getElementById(`weight-${id}`)?.value) || 0;
    total += w;
  });
  document.getElementById('finalWeight').value = total > 0 ? total : '';
}

/* Проверка включения кнопки "Рассчитать" */
function checkCalculateButton() {
  const btn = document.getElementById('calculateBtn');
  let ok = false;
  for (const id of activeIngredients) {
    const weight = parseFloat(document.getElementById(`weight-${id}`)?.value) || 0;
    const cal = parseFloat(document.getElementById(`cal-${id}`)?.value) || 0;
    const prot = parseFloat(document.getElementById(`prot-${id}`)?.value) || 0;
    const fat = parseFloat(document.getElementById(`fat-${id}`)?.value) || 0;
    const carb = parseFloat(document.getElementById(`carb-${id}`)?.value) || 0;
    if (weight > 0 && (cal > 0 || prot > 0 || fat > 0 || carb > 0)) { ok = true; break; }
  }
  btn.disabled = !ok;
  btn.classList.toggle('btn-disabled', !ok);
}

/* Расчёт КБЖУ */
function calculate() {
  const finalWeight = parseFloat(document.getElementById('finalWeight')?.value) || 0;
  if (!finalWeight || finalWeight <= 0) {
    alert('Укажите вес готового блюда (сумма весов ингредиентов)');
    return;
  }

  let totalCal = 0, totalProt = 0, totalFat = 0, totalCarb = 0;

  activeIngredients.forEach(id => {
    const name = document.getElementById(`name-${id}`)?.value || '';
    const weight = parseFloat(document.getElementById(`weight-${id}`)?.value) || 0;
    const cal = parseFloat(document.getElementById(`cal-${id}`)?.value) || 0;
    const prot = parseFloat(document.getElementById(`prot-${id}`)?.value) || 0;
    const fat = parseFloat(document.getElementById(`fat-${id}`)?.value) || 0;
    const carb = parseFloat(document.getElementById(`carb-${id}`)?.value) || 0;

    if (weight > 0) {
      totalCal += (cal * weight) / 100;
      totalProt += (prot * weight) / 100;
      totalFat += (fat * weight) / 100;
      totalCarb += (carb * weight) / 100;

      // сохраняем локальный продукт (если назван и не дубль)
      if (name && (cal > 0 || prot > 0 || fat > 0 || carb > 0)) {
        const exists = customProducts.some(p => p.name.toLowerCase() === name.toLowerCase());
        if (!exists) {
          customProducts.push({ name, cal, prot, fat, carb });
        }
      }
    }
  });

  // сохраняем локальную базу (если есть новые)
  saveCustomToStorage();

  const per100 = {
    cal: Math.round((totalCal / finalWeight) * 100),
    prot: Math.round((totalProt / finalWeight) * 100),
    fat: Math.round((totalFat / finalWeight) * 100),
    carb: Math.round((totalCarb / finalWeight) * 100)
  };

  document.getElementById('resCalories').value = isFinite(per100.cal) ? per100.cal : 0;
  document.getElementById('resProtein').value = isFinite(per100.prot) ? per100.prot : 0;
  document.getElementById('resFat').value = isFinite(per100.fat) ? per100.fat : 0;
  document.getElementById('resCarbs').value = isFinite(per100.carb) ? per100.carb : 0;

  document.getElementById('result').classList.add('show');
  displayHistory();
}

/* ====== История блюд ====== */
function saveToHistory() {
  const name = document.getElementById('dishName').value.trim() || 'Без названия';
  const note = document.getElementById('dishNote').value.trim();
  const cal = document.getElementById('resCalories').value || 0;
  const prot = document.getElementById('resProtein').value || 0;
  const fat = document.getElementById('resFat').value || 0;
  const carb = document.getElementById('resCarbs').value || 0;

  const dish = {
    name, note, cal, prot, fat, carb, date: new Date().toLocaleString('ru-RU')
  };

  history.unshift(dish);
  if (history.length > 100) history = history.slice(0, 100);
  saveHistoryToStorage();
  displayHistory();
  alert('Блюдо сохранено в историю');
}

function displayHistory() {
  const section = document.getElementById('historySection');
  const list = document.getElementById('historyList');
  if (!history || history.length === 0) {
    section.style.display = 'none';
    list.innerHTML = '';
    return;
  }
  section.style.display = 'block';
  list.innerHTML = history.map((d, idx) => `
    <div class="history-item" data-idx="${idx}">
      <div style="flex:1;cursor:pointer" onclick="loadFromHistory(${idx})">
        <div style="font-weight:600;color:#f5f5f5">${escapeHtml(d.name)}</div>
        <div class="small-muted" style="margin-top:6px">${d.cal} ккал · Б: ${d.prot}г · Ж: ${d.fat}г · У: ${d.carb}г</div>
        ${d.note ? `<div class="small-muted" style="margin-top:8px;font-style:italic;border-top:1px solid #2a2a2a;padding-top:8px">${escapeHtml(d.note)}</div>` : ''}
      </div>
      <button class="history-delete" onclick="deleteHistoryItem(${idx}, event)" title="Удалить из истории">✕</button>
    </div>
  `).join('');
}

function deleteHistoryItem(index, e) {
  e.stopPropagation();
  if (!confirm('Удалить это блюдо из истории?')) return;
  history.splice(index, 1);
  saveHistoryToStorage();
  displayHistory();
}

function loadFromHistory(index) {
  const d = history[index];
  if (!d) return;
  document.getElementById('resCalories').value = d.cal;
  document.getElementById('resProtein').value = d.prot;
  document.getElementById('resFat').value = d.fat;
  document.getElementById('resCarbs').value = d.carb;
  document.getElementById('dishName').value = d.name;
  document.getElementById('dishNote').value = d.note || '';
  document.getElementById('result').classList.add('show');
  window.scrollTo({top:document.getElementById('result').offsetTop - 20, behavior:'smooth'});
}

function clearHistory() {
  if (!confirm('Удалить всю историю?')) return;
  history = [];
  saveHistoryToStorage();
  displayHistory();
}

/* ====== Помощь / escape ====== */
function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}

/* ====== Инициализация кнопок и старт ====== */
document.getElementById('addIngredientBtn').addEventListener('click', () => addIngredient());
document.getElementById('calculateBtn').addEventListener('click', () => calculate());
document.getElementById('saveBtn').addEventListener('click', () => saveToHistory());
document.getElementById('newBtn').addEventListener('click', () => newDish());
document.getElementById('clearHistoryBtn').addEventListener('click', () => clearHistory());

// при изменении веса вручную — обновляем суммарный вес и кнопку
document.getElementById('finalWeight').addEventListener('input', () => checkCalculateButton());

function newDish() {
  // очищаем форму, но не локальную базу
  document.getElementById('ingredients').innerHTML = '';
  ingredientCount = 0;
  activeIngredients.length = 0;
  document.getElementById('finalWeight').value = '';
  document.getElementById('result').classList.remove('show');
  document.getElementById('dishName').value = '';
  document.getElementById('dishNote').value = '';
  addIngredient();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* старт */
addIngredient();
displayHistory();

/* Обработчик клика вне автодопа: закрывает все */
document.addEventListener('click', (e) => {
  if (!e.target.closest('.autocomplete-wrapper')) {
    document.querySelectorAll('.autocomplete-list').forEach(l => l.classList.remove('show'));
  }
});
</script>
</body>
</html>
