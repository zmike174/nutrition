<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>КБЖУ</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
background:#1a1a1a;color:#e8e8e8;padding:24px;padding-bottom:120px
}
.container{max-width:680px;margin:0 auto}
h1{font-size:28px;margin-bottom:28px;font-weight:400}

.ingredient{background:#2d2d2d;border-radius:14px;padding:20px;margin-bottom:16px;border:1px solid #404040}
.ingredient-header{display:flex;justify-content:space-between;margin-bottom:16px;color:#9b9b9b}
.remove-btn{background:none;border:none;color:#a35705;font-size:18px;cursor:pointer}

label{font-size:14px;color:#9b9b9b;margin-bottom:6px;display:block}
input,textarea{
width:100%;padding:14px;border-radius:10px;
border:1px solid #404040;background:#1a1a1a;color:#fff;
margin-bottom:14px;font-size:16px
}
input:disabled{opacity:.6}

.kbju-labels,.kbju-grid{
display:grid;grid-template-columns:repeat(4,1fr);gap:10px
}
.kbju-labels label{text-align:left;font-size:13px}

button{
width:100%;padding:16px;border-radius:12px;
border:1px solid #404040;background:#2d2d2d;color:#fff;
font-size:16px;cursor:pointer;margin-top:16px
}
.calculate-btn{background:#a35705;border:none;font-weight:600}

.result{display:none;background:#2d2d2d;padding:20px;border-radius:14px;margin-top:24px}
.result.show{display:block}

.result-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.result-item input{text-align:left;font-weight:600}

.autocomplete-wrapper{position:relative}
.autocomplete-list{
position:absolute;top:100%;left:0;right:0;
background:#2d2d2d;border:1px solid #404040;border-radius:12px;
max-height:240px;overflow:auto;z-index:1000;display:none
}
.autocomplete-item{
padding:14px;display:flex;justify-content:space-between;
cursor:pointer
}
.autocomplete-item:hover{background:#3a3a3a}
.autocomplete-item span{opacity:.6}
.autocomplete-item button{
background:none;border:none;color:#a35705;font-size:16px;cursor:pointer
}
</style>
</head>

<body>
<div class="container">
<h1>Калькулятор КБЖУ</h1>

<div id="ingredients"></div>

<button onclick="addIngredient()">Добавить ингредиент</button>

<label style="display:flex;gap:10px;align-items:center;margin-top:20px">
<input type="checkbox" id="noCooking" onchange="toggleCooking()"> Без термической обработки
</label>

<label>Вес готового блюда (г)</label>
<input type="number" id="finalWeight">

<button class="calculate-btn" onclick="calculate()">Рассчитать</button>

<div class="result" id="result">
<h2 style="margin-bottom:16px">Результат (на 100 г)</h2>
<div class="result-grid">
<input readonly id="resCal">
<input readonly id="resProt">
<input readonly id="resFat">
<input readonly id="resCarb">
</div>
</div>
</div>

<script>
const baseProducts=[
{name:'Масло подсолнечное',cal:899,prot:0,fat:99.9,carb:0},
{name:'Грудка куриная',cal:113,prot:23.6,fat:1.9,carb:0.4}
];

let customProducts=JSON.parse(localStorage.getItem('custom_products')||'[]');
let ingredientId=0;
let noCooking=false;

function allProducts(){
return [
...customProducts.sort((a,b)=>a.name.localeCompare(b.name)),
...baseProducts.sort((a,b)=>a.name.localeCompare(b.name))
];
}

function deleteCustom(name){
customProducts=customProducts.filter(p=>p.name!==name);
localStorage.setItem('custom_products',JSON.stringify(customProducts));
}

function toggleCooking(){
noCooking=document.getElementById('noCooking').checked;
const fw=document.getElementById('finalWeight');
fw.disabled=noCooking;
if(noCooking) updateFinalWeight();
}

function updateFinalWeight(){
if(!noCooking) return;
let total=0;
document.querySelectorAll('[id^="weight-"]').forEach(i=>{
total+=parseFloat(i.value)||0;
});
document.getElementById('finalWeight').value=total||'';
}

function addIngredient(){
ingredientId++;
const d=document.createElement('div');
d.className='ingredient';
d.innerHTML=`
<div class="ingredient-header">
Ингредиент
<button class="remove-btn" onclick="this.closest('.ingredient').remove()">✕</button>
</div>

<div class="autocomplete-wrapper">
<label>Название</label>
<input id="name-${ingredientId}" oninput="showAuto(${ingredientId})">
<div class="autocomplete-list" id="list-${ingredientId}"></div>
</div>

<div class="kbju-labels">
<label>Калории</label><label>Белки</label><label>Жиры</label><label>Углев.</label>
</div>
<div class="kbju-grid">
<input id="cal-${ingredientId}">
<input id="prot-${ingredientId}">
<input id="fat-${ingredientId}">
<input id="carb-${ingredientId}">
</div>

<label>Вес (г)</label>
<input id="weight-${ingredientId}" oninput="updateFinalWeight()">
`;
document.getElementById('ingredients').appendChild(d);
}

function showAuto(id){
const v=document.getElementById(`name-${id}`).value.toLowerCase();
const list=document.getElementById(`list-${id}`);
if(!v){list.style.display='none';return}

list.innerHTML='';
allProducts().filter(p=>p.name.toLowerCase().includes(v)).forEach(p=>{
const item=document.createElement('div');
item.className='autocomplete-item';
item.innerHTML=`${p.name}${customProducts.find(c=>c.name===p.name)?'<button>✕</button>':''}`;
item.onclick=()=>{
document.getElementById(`name-${id}`).value=p.name;
document.getElementById(`cal-${id}`).value=p.cal;
document.getElementById(`prot-${id}`).value=p.prot;
document.getElementById(`fat-${id}`).value=p.fat;
document.getElementById(`carb-${id}`).value=p.carb;
list.style.display='none';
};
if(customProducts.find(c=>c.name===p.name)){
item.querySelector('button').onclick=e=>{
e.stopPropagation();
deleteCustom(p.name);
showAuto(id);
};
}
list.appendChild(item);
});
list.style.display='block';
}

function calculate(){
let tc=0,tp=0,tf=0,tu=0;
document.querySelectorAll('[id^="weight-"]').forEach(w=>{
const id=w.id.split('-')[1];
const weight=parseFloat(w.value)||0;
tc+=weight*(parseFloat(document.getElementById(`cal-${id}`).value)||0)/100;
tp+=weight*(parseFloat(document.getElementById(`prot-${id}`).value)||0)/100;
tf+=weight*(parseFloat(document.getElementById(`fat-${id}`).value)||0)/100;
tu+=weight*(parseFloat(document.getElementById(`carb-${id}`).value)||0)/100;
});

const fw=parseFloat(document.getElementById('finalWeight').value);
document.getElementById('resCal').value=Math.round(tc/fw*100);
document.getElementById('resProt').value=Math.round(tp/fw*100);
document.getElementById('resFat').value=Math.round(tf/fw*100);
document.getElementById('resCarb').value=Math.round(tu/fw*100);

document.getElementById('result').classList.add('show');
}

addIngredient();
</script>
</body>
</html>
